\section
{$M^X/M/1$ Queue: Expected Waiting Time}
%{$\mathbf{M^X/M/1}$ Queue: Expected Waiting Time}
\label{sec:mxm1-queue:-expected}

\subsection*{Theory and Exercises}

\Opensolutionfile{hint}
\Opensolutionfile{ans}

It is not always the case that jobs arrive in single units, they can
also arrive in batches. For instance, when a car and or bus arrives at a fast
food restaurant, a batch consists of the number of people in the vehicle.  In this section we derive for such queueing processes, denoted by the shorthand $M^X/M/1$, expressions for the load and the expected waiting time and queue length. 


Assume that jobs arrive as a Poisson process with rate $\lambda$ and each \emph{job} contains multiple \emph{items}.
Let $A_k$ be the arrival time of job $k$ and $A(t)$ the number of job arrivals up to time $t$.
Denote by $B_k$ the batch size, i.e., the number of items that job $k$ brings into the system\footnote{Do not confuse this $B$ with the busy time of the server}.
We assume that $\{B_k\}$ is a sequence of i.i.d.
discrete random variables distributed as a generic random variable $B$ such that $\P{B = k} = f(k)$, where $f(k)$ is a given set of probabilities.
We write
\begin{equation*}
  G(k) = \P{B>k} = \sum_{m=k+1}^\infty f(m),
\end{equation*}
for the \emph{survivor function} of $B$.  We also assume that the
service time of each item is exponentially distributed with average
$1/\mu$. Thus, the average time to serve the entire batch is
\begin{equation*}
\E{B}\E{S}=\E B/\mu.
\end{equation*}



The first criterion we must check for the $M^X/M/1$ queue is the
stability: the service rate must be larger than the arrival rate of
work. 

\begin{exercise} Use the renewal reward theorem to explain that work arrives at rate $\lambda \E B$.
  \begin{hint}
Observe that the total number of items is given by
\begin{equation*}
Y(t)=  \sum_{k=1}^{A(t)} B_k.
\end{equation*}
What should you take for the times $\{T_k\}$? 
  \end{hint}
\begin{solution}
Take $T_k = A_k$. Then $X_k = Y(A_k) - Y(A_{k-1}) = B_k$.  Then $Y=\lambda  X$ implies that the arrival rate of work $Y(t)/t \to \lambda \E B$. 
\end{solution}
\end{exercise}

With this, define the load as
\begin{equation*}
\rho = \lambda \E B/\mu.
\end{equation*}
We require of course that hence we require $\rho< 1$.


Let us next find expressions for the expected time batches wait in queue $\E{W_{Q, b}}$. For this, assume that a batch joins the end of the queue (if present), and once the queue in front of it is cleared, the entire batch moves from the queue to the server.
% Then the server starts serving the batch. As the service of the first item of the batch starts right away, this item does not have to wait. The last item, however, must wait for all the other items of the batch to be served before its service can start. Consequently, all items of a batch, except the first, also have to wait at the server before service starts. 

Suppose a batch finds $\E{L}$ items in the system upon arrival. Then, by the memoryless property of the service distribution, 
\begin{equation*}
  \E{W_{Q,b}} = \E{L} \E S;
\end{equation*}
compare Eq.~\eqref{eq:wqes}. 
%Note that this is not the same as $\E{W_Q}$, which is the expected time an \emph{item} spends in queue.
Next, if $B_r$ is the number of items of the batch currently at the server
($B_r=0$ if the server is idle), and $L_{Q,b}$ the number of batches
in queue, we have that
\begin{equation*}
  \E{L} = \E{L_{Q,b}}\E B + \E{B_r}.
\end{equation*}
\begin{exercise}
  Combine the above with  Little's law to show that
  \begin{equation*}
  \E{W_{Q,b}} = \frac{\E{B_r}}{1-\rho}\E{S}.
  \end{equation*}
\begin{solution}
\begin{equation*}
  \E{W_{Q,b}} 
= \E{L} \E S  = (\E{L_{Q,b}}\E B + \E{B_r})\E S.
\end{equation*}
With  Little's law, $\E{L_{Q,b}} = \lambda \E{W_{Q,b}}$,
\begin{equation*}
  \E{W_{Q,b}} 
= \lambda \E S \E B \E{W_{Q,b}} + \E S \E{B_r} = \rho \E{W_{Q,b}} + \E S \E{B_r},
\end{equation*}
hence,
\begin{equation*}
  \E{W_{Q,b}} = \frac{\E{B_r}}{1-\rho}\E S.
\end{equation*}
\end{solution}
\end{exercise}

Below we will find an expression for $\E{B_r}$. This results in two cornerstone of queueing theory. The first is the expected waiting time, 
\begin{equation}
\E{W_{Q,b}} = \frac{1+C_s^2}2 \frac{\rho}{1-\rho} \E B \E S + \frac12\frac\rho{1-\rho}\E S,
\end{equation}
where  $C_s^2 = \V B / (\E B)^2$ is the SCV of the batch size distribution.
For the second, apply  Little's law to find  that the expected number of items in the system is
\begin{equation}\label{eq:43}
\E{L}  =\frac{\E{W_{Q,b}}}{\E S} =  
\frac{1+C_s^2}2 \frac{\rho}{1-\rho} \E B + \frac12\frac\rho{1-\rho}.
\end{equation}
Thus, to compute the average number of items in the system, we only
need to know the first and second moment (or the variance) of the
batch size $B$. Thus, no matter how `complicated' the distribution of
$B$, when its second moment exists, the average queue length and
waiting time can be computed with the above result. 

\begin{exercise}[\faFlask]
  Show that  when the batch size is 1, the expression $\E{L(M^X/M/1)}$, i.e., the system length for the $M^X/M/1$ queue, reduces to
  $\E{L(M/M/1)}$, i.e., the system length for the $M/M/1$ queue. 
  \begin{hint}
What is the    distribution of the batch size $B$ for the $M/M/1$ queue?
  \end{hint}
  \begin{solution}
    For the $M/M/1$ queue, each job contains just one item. Thus,
    $B\equiv 1$, hence $\P{B=1}=1$, $\E{B^2}=\E B =1$. Therefore,
    $\E{B_r(M/M/1)}= \rho$, and $\E{L(M/M/1)}=\rho/(1-\rho)$. 
  \end{solution}
Realize the importance of such checks.
\end{exercise}


\begin{exercise}[\faCalculator]
  What is $\E L$ in case $B_k=3$ always, and $\lambda=1$, $\mu=6$?  
  \begin{hint}
Use Eq.~\eqref{eq:43}. What are $\E{B^2}$, $\E B$ and $\V B$ for this case?
  \end{hint}
\begin{solution}
  As $B$ is constant and equal to 3, $\E{B^2}=9$. Hence, $\V B=0$, which implies
 $C_s^2=0$.  Also, $\rho=\lambda\E B/\mu=1\cdot 3/6=1/2$. Hence,
  \begin{equation*}
    \E L = \frac 1 2 \frac{1/2}{1-1/2}\cdot 3 + \frac12\frac{1/2}{1-1/2}.
  \end{equation*}
  \end{solution}
\end{exercise}

\begin{exercise}[\faCalculator]
  If the batch size is $p$ geometrically distributed, what is $\E L$?
  \begin{hint}
$f_k=q^{k-1}p$ with $q=1-p$. Use generating functions to compute $\E B$ and $\E{B^2}$.
  \end{hint}
\begin{solution}
  We need $\V B$ and $\E B$. Consider
  \begin{align*}
    M_B(s) 
&= \E{e^{sB}} = \sum_{k=0}^\infty e^{sk} \P{B=k} \\
&= \sum_{k=0}^\infty e^{sk} p q^{k-1} 
= \frac p q \sum_{k=0}^\infty (q e^s)^k = \frac p q \frac1{1-qe^s},\\
  \E B &= M_B'(0) = \left.\frac p q \frac q{(1-q e^s)^2}\right|_{s=0}= \frac p{(1-q)^2} = \frac 1 p,\\
  \E{B^2)} &= M_B''(0) = \frac2{p^2} - \frac1p, \\
  \V B &= \E{B^2} - (\E B)^2 = \frac2{p^2} - \frac1p - \frac1{p^2} = \frac1{p^2}-\frac1p,\\
  C_s^2&= \frac{\V B}{(\E B)^2} = p^2 \left(\frac1{p^2}-\frac1p\right)=1-p,\\
  (1+C_s^2)/2 &= 1-p/2\\
  \E L &= 
\left(1-\frac p2\right) \frac\rho{1-\rho} \frac 1 p + \frac12\frac\rho{1-\rho}
=\frac\rho{1-\rho} \frac 1 p.
\end{align*}

Can we check this in a simple way? If $\P{B=1}=f_1 = p =1$, then
$\E L=\rho/(1-\rho)$. Thus, we get the result for the $M/M/1$
queue. The result is at least consistent with earlier work.
\end{solution}
\end{exercise}

\begin{exercise}[\faPhoto]
  A common operational problem is a machine that receives batches of
  various sizes. Management likes to know how a reduction of the
  variability of the batch sizes would affect the average queueing time.
  Suppose, for the sake of an example, that the batch size 
  \begin{equation*}
    \P{B=1} = \P{B=2} = \P{B=3} = \frac 13.
  \end{equation*}
  Batches arrive at rate 1 per hour. The average processing time for an
  item is $25$ minutes.  By how much would the number of items in de system decrease if
  batch sizes are constant and equal to~$2$ (observe that in both cases $\E B =2$).
  \begin{solution}
    Start with the simple case, $B\equiv 2$. Then $\V{B}=0$ and
    $\E B = 2$. The load is $\rho=\lambda \E B \E S = 1\cdot 2 \cdot 25/60 = 5/6$.  Hence,
    \begin{equation*}
      \E{L} = \frac 12 \frac{5/6}{1/6} 2 + \frac 12 \frac{5/6}{1/6} = 5 + \frac52.
    \end{equation*}

Now the other case. $\E{B^2} = (1+4+9)/3 = 14/3$. Hence, $\V B=14/3 - 4=2/3$. Hence, 
\begin{equation*}
C_s^2=\frac{\V B}{(\E B)^2} = \frac{2/3}4 = \frac 16.
\end{equation*}
And thus, 
    \begin{equation*}
      \E{L} = \frac {1+1/6}2 \frac{5/6}{1/6} 2 + \frac 12 \frac{5/6}{1/6} = \frac76 5 + \frac 52.
    \end{equation*}
    If we divide these two answers, we see that the ratio between
    $\E{L}$ for both answers is $10/9$. In other words, we can
    reduce about 10\% of the number of items in the system by working
    in fixed batch sizes. 
  \end{solution}
\end{exercise}

Observe how easy it is with these models to get insight into the order
of magnitude of queue length reductions or waiting times that can be
achieved with changing work habits, such as making batch sizes constant
rather than allowing them to vary. Observe also that it is up to
management to decide whether such reductions outweigh any efforts to
reduce the variation in batch sizes. 


\begin{exercise}[\faFlask]
  Show that $\E{L(M^X/M/1)} \geq \E{L(M/M/1)}$ when the loads are the
    same. What do you conclude?
  \begin{solution}
    \begin{equation*}
    \frac{\E{L(M^X/M/1)}}{\E{L(M/M/1)}} = \frac{\E{B_r}}{\rho} = 
\frac{\E{B^2}}{2\E B} + \frac 12.
    \end{equation*}
With this we can check whether this condition
    \begin{equation*}
    1\leq \frac{\E{L(M^X/M/1)}}{\E{L(M/M/1)}} = \frac{\E{B^2}}{2\E B} + \frac 12
    \end{equation*}
    is always true. Clearly, it reduces to
\begin{equation*}
\E B \leq  \E{B^2}.
\end{equation*}
Multiply this by $\E B$ for reasons to become clear presently to get
\begin{equation*}
(\E B)^2 \leq  \E{B^2} \E B.
\end{equation*}
So, the initial inequality is converted to this, and we like to know
whether this always true.


To see this, we can use Jensen's inequality
$\phi(\E X) \leq \E{\phi(X)}$ when $\phi$ is convex. In this case take
$\phi(x)=x^2$, so that Jensen's inequality states that
$(\E B)^2 \leq \E{B^2}$. (BTW, note that Jensen's inequality implies
that $\V X = \E{X^2} - (\E X)^2\geq 0$.)  Now noting that $B\geq 1$, as a
job minimally contains one item, we get
\begin{equation*}
  \begin{split}
(\E B)^2 
&\leq  \E{B^2}, \quad{\text{by Jensen's inequality}} \\
&\leq   \E{B^2} \E B, \quad{\text{ as } B \geq 1}.
  \end{split}
\end{equation*}
Clearly, this is the inequality we tried to show. As a result,
    \begin{equation*}
    1\leq \frac{\E{L(M^X/M/1)}}{\E{L(M/M/1)}}
    \end{equation*}
for all $B$. 

In conclusion, if work arrives in batches, the average number of jobs
in the system increases, hence the average waiting time increases.
  \end{solution}
\end{exercise}



\begin{exercise}[\faPhoto]
  In a production environment, a machine replenishes an inventory of
  items (e.g., hamburgers) at a fixed rate of $1$ per 3 minutes. If
  the inventory reaches the \emph{produce-up-to} level $S$, the machine stops.  Customers
  arrive at rate of 6 per hour. A customer can buy items in different
  quantities, $B=1,2,3,4$, all with equal probability. What is a
  sensible value for the produce-up-to level $S$?   
  \begin{hint}
Realize that the inventory process $I(t)$ behaves as     $I(t)=S-L(t)$ where $L(t)$ is a suitable queueing process. Refer to Ex.~\ref{ex:7} for further background.
  \end{hint}
  \begin{solution}
Consider a queueing system with job
arrival rate $\lambda=6$ per hour and the jobs have batch sizes as
indicated in the problem. The average number of items in the system
follows like this:
    \begin{align*}
      \E B &= \frac{1+2+3+4}{4} = \frac 52, \\
      \E{B^2} &= \frac{1+4+9+16}{4} = \frac{30}4,\\
      \V{B} &= \frac{30}4 - \frac{25}4 = \frac 5 4,\\
      C_s^2 &= \frac{5/4}{25/4} = \frac 15,\\
      \rho &= \lambda \E B \E S = 6 \frac 52 \frac 1{20} = \frac 34.
    \end{align*}
Hence, 
\begin{equation*}
  \E{L} = \frac {1+1/5}2 \frac{3/4}{1/4} \frac 52 + \frac 12 \frac{3/4}{1/4} = 6.
\end{equation*}

Thus, if the level is set to $S=4$, then on average there will be two
items short. Clearly, then, $S$ should be at least $6$. However,
$\E{L}$ is just the average. Roughly speaking, in this case half of
the demand will then be lost. So, if we take variability into account,
$S$ should be quite a bit bigger than 6. 

A more detailed analysis is
necessary to determine the right value of $S$ such that not more than
a certain fraction of demand is lost. We will address this issue in
Section~\ref{sec:batch-arrivals}.
  \end{solution}
\end{exercise}



We now turn to finding an expression for $\E{B_r}$;  for this we can again use the renewal reward theorem. 
Let $L_s(s)$ be the number of items (of the batch in service) at the server. Then
\begin{equation*}
  Y_i(t) = \int_0^t \1{L_S(s)=i} \d s
\end{equation*}
is the total time up to time $D(t)$ that there are $i$ items at the server. 

\begin{exercise}
  Let $\tilde A_k$ be the moment the $k$th batch moves to the server and $D_k$ its departure time.
  Use Figure~\ref{fig:remainingservicetime} to show that
\begin{equation*}
  \int_{\tilde A_k}^{D_k} \1{L_S(s)=i} \d s = S_{k,i} \1{B_k \geq i},
\end{equation*}
where $S_{k,i}$ is the service time of the $i$th item of this batch.
\begin{solution}
Only if $B_k \geq i$ there can be an $i$th item of the batch, and then the time this $i$th item spends at the server is its service time $S_{k,i}$.   
\end{solution}
\end{exercise}




\begin{figure}[th]
  \centering
  \begin{tikzpicture}[yscale=0.8,xscale=0.6,
  open/.style={shape=circle, fill=white, inner sep=1pt, draw, node contents=},
  closed/.style={shape=circle, fill=black, inner sep=1pt, draw, node contents=}]

    % y = zero line
    \draw (-0.5, 0) -- (18.5, 0); 
    % level crossing
    \draw (-0.5, 2.5) -- (18.5, 2.5) 
    node[pos=0.65, fill=white, above]  {$\sum_{k=1}^n \1{B_k \geq i}$}
    node[pos=0.92, fill=white]  {$y=i$};


    \draw node (c1) at (0,3.5) [closed, label={}]
          node (c2) at (3.5,0)[open, label={}]
     (c1) to (c2);
    \draw[dotted] (0,0) -- (0,3.5) node[midway, fill=white] {$B_1$};
    \draw[dotted, <->] (1, 0.05) -- (1, 2.45) node[fill=white, midway, rotate=90] {$i$};


    \draw node (c1) at (3.5,1.5) [closed, label={}]
          node (c2) at (5,0)[open, label={}]
     (c1) to (c2);
    \draw[dotted] (3.5,0.1) -- (3.5,1.5) node[midway, fill=white] {$B_2$};

    \draw node (c1) at (5,4) [closed, label={}]
          node (c2) at (9,0)[open, label={}]
     (c1) to (c2);
    \draw[dotted] (5,0.1) -- (5,4) node[midway, fill=white] {$B_3$};
    \draw[dotted, <->] (6.5, 0.05) -- (6.5, 2.45) node[fill=white, midway, rotate=90] {$i$};

    \draw node (c1) at (9,2.3) [closed, label={}]
          node (c2) at (11.3,0)[open, label={}]
     (c1) to (c2);
    \draw[dotted] (9,0.1) -- (9,2.3) node[midway, fill=white] {$B_4$};

    % end
    \draw node (c1) at (14.5,3.5) [closed, label={}]
          node (c2) at (18,0)[open, label={}]
     (c1) to (c2);
    \draw[dotted] (14.5,0.1) -- (14.5,3.5) node[midway, fill=white ] {$B_n$};
    \draw[dotted, <->] (15.5, 0.05) -- (15.5, 2.45) node[fill=white, midway, rotate=90] {$i$};
    

    % bottom line
    \draw[<->] (0, -0.6) -- (18, -.6) node[fill=white, midway] {$\sum_{k=1}^n B_k$};
\end{tikzpicture}

\caption{The remaining job size as a function of time. The
  total number of service periods, which is equal to the number of items arrived, is $\sum_{k=1}^n B_k$. A batch crosses   the line $y=i$ iff it contains at least $i$ items. Thus, during the service of a batch with $i$ or more items, there is precisely one  period during which the $i$-th item of a batch  is waiting in queue. Consequently, $\sum_{k=1}^n \1{B_k\geq i}$ is the number of periods in which there are precisely $i$ items waiting at the server. The fraction of  periods  there are~$i$ items is therefore
  $\sum_k^n \1{B_k\geq i}/\sum_k^n B_k$.}
  \label{fig:remainingservicetime}
\end{figure}


\begin{exercise}
Use the previous exercise to show that 
\begin{equation*}
  Y_i(D_n) = \sum_{k=1}^n \1{B_k\geq i} S_{k,i}.
\end{equation*}
\begin{hint}
  Observe that $n$ batches have been served at time $D_n$.
\end{hint}
\begin{solution}
  At the departure time $D_n$ of the $n$th batch, precisely $n$ batches have been served.
  Thus, each batch $k$ with more than $i$ items contributed to $Y_i(D_n)$ with the service time $S_{k,i}$.
\end{solution}
\end{exercise}

\begin{exercise}
  Now use the renewal reward theorem to see that the (time-average) fraction of time there are $i$ items at the server is equal to
  \begin{equation*}
    \P{B_r = i} = \lambda \E{S} G(i-1) = \rho \frac{G(i-1)}{\E B}.
  \end{equation*}
  \begin{solution}
By construction, $Y_I(t)/t \to \P{B_r=i}$. Let $X_k = Y_i(D_k) - Y_i(D_{k-1})$.  Then $\E{X_k} = \E{S_{k,i} \1{B_{k} \geq i}}$ by the previous exercises. Now $B_k$ and $S_{k_,i}$ are independent by assumption. Hence $\E{X_k} = \E{S} \E{\1{B\geq i}} = \E S \P{B\geq i}$, since $S_{k,i}$ are i.i.d., just at $\{B_k\}$. Therefore, in the renewal reward theorem, $X=\E S \P{B\geq i}$, and the result follows by rate stability ($\delta = \lambda$). 
  \end{solution}
\end{exercise}

With the above exercises we conclude that
\begin{equation*}
  \E{B_r} = \sum_{i=0}^\infty i \P{B_r=i} = \frac{\rho}{\E B} \sum_{i=1}^\infty i G(i-1).
\end{equation*}
It remains to brush up this formula.


\begin{exercise}\label{ex:ER}
  Show that
  \begin{equation*}
  \sum_{i=1}^\infty i G(i-1)= \frac{\E{B^2} + \E B}{2},
\end{equation*}
so that
\begin{equation*}
  \E{B_r} = \rho \frac{\E{B^2}}{2 \E B} + \frac{\rho}{2}.
\end{equation*}

  \begin{hint}
    Use Exercises~\ref{ex:6} and \ref{ex:66}.
  \end{hint}
  \begin{solution}
\begin{equation*}
  \begin{split}
 \sum_{i=1}^\infty i G(i-1) 
&=\sum_{i=0}^\infty (i+1) G(i) 
=\sum_{i=0}^\infty i G(i) +
\sum_{i=0}^\infty G(i)\\
&= (\E{B^2} - \E B + 2\E B)/2.
  \end{split}
\end{equation*}
  \end{solution}
\end{exercise}


\begin{exercise}\label{q:batch}
Finally, 
\begin{equation*}
\rho  \frac{\E{B^2}}{2\E{B}} = \frac{1+C_s^2}{2} \rho \E B.
\end{equation*}
  \begin{solution}
We have
\begin{align*}
  \frac{\E{B^2}}{\E{B}}
&=    \frac{\E{B^2}}{(\E B)^2} \E B 
=    \frac{\E{B^2} - (\E B)^2 + (\E B)^2}{(\E B)^2} \E B  \\
&= \frac{\V B + (\E B)^2}{(\E B)^2}\E B = (C_s^2+1)\E B.
\end{align*}
  \end{solution}
\end{exercise}




\Closesolutionfile{hint}
\Closesolutionfile{ans}

\opt{solutionfiles}{
\subsection*{Hints}
\input{hint}
\subsection*{Solutions}
\input{ans}
}

%\clearpage

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../queueing_book"
%%% End:

